name: aks-install-csi-akv

on:
  workflow_dispatch:
  workflow_call:

permissions:
  id-token: write
  contents: read

env:
  KEYVAULT_TENANT_ID: ${{ secrets.TENANT_ID }}
  HELM_RELEASE_PREFIX: secrets-store

jobs:
  deploy-csi-akv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AKS_CLIENT_ID }}
          tenant-id: ${{ secrets.TENANT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

      - name: Set AKS Context
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RG }} \
            --name ${{ secrets.AKS_NAME }} \
            --overwrite-existing

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Add Helm repos
        run: |
          helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
          helm repo update

      - name: Install Secrets Store CSI Driver (only if not present)
        run: |
          set -e
          if helm status csi-secrets-store -n kube-system >/dev/null 2>&1; then
            echo "Helm release 'csi-secrets-store' already installed. Skipping."
          elif kubectl get ds -n kube-system secrets-store-csi-driver >/dev/null 2>&1; then
            echo "DaemonSet 'secrets-store-csi-driver' already running. Skipping."
          elif kubectl get pods -n kube-system -l app=secrets-store-csi-driver | grep Running >/dev/null 2>&1; then
            echo "Secrets Store CSI Driver pods already running. Skipping."
          else
            echo "Installing Secrets Store CSI Driver..."
            helm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver \
              --namespace kube-system \
              --set syncSecret.enabled=true \
              --set enableSecretRotation=true \
              --wait --timeout 10m
          fi

      - name: Create sample SecretProviderClass
        working-directory: aks-microservices/app/
        run: |
          pwd
          ls /home/runner/work/aks-microservices/aks-microservices/aks-microservices/app/manifests/
          # render template from repo and apply via stdin (never commit rendered file)
          envsubst < ./secretproviderclass.tpl.yaml | kubectl apply -f -

      - name: Wait for pods in kube-system ready
        run: |
          kubectl -n kube-system rollout status daemonset/secrets-store-csi-driver --timeout=3m || true
        # kubectl -n kube-system rollout status deployment/${HELM_RELEASE_PREFIX}-akv-provider-secrets-store-csi-driver --timeout=3m || true

      - name: Verify provider pods
        run: |
          kubectl get pods -n kube-system -l "app=secrets-store-csi-driver" -o wide
        # kubectl get pods -n kube-system -l app=secrets-store-csi-driver-provider-azure -o wide