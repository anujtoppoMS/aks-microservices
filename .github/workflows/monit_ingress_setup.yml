name: Monitoring Setup

on:
  workflow_dispatch:   # manual trigger
  workflow_call:

jobs:
  setup-monitoring:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.29.0'

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: 'v3.13.0'

    - name: Azure Login via OIDC
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AKS_CLIENT_ID }}
        tenant-id: ${{ secrets.TENANT_ID }}
        subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

    - name: Set AKS Context
      run: |
        az aks get-credentials \
        --resource-group ${{ secrets.AKS_RG }} \
        --name ${{ secrets.AKS_NAME }} \
        --overwrite-existing

    - name: Ensure monitoring namespace exists
      run: |
        kubectl get ns monitoring || kubectl create ns monitoring

    - name: Add Helm repos
      run: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update

    - name: Check Helm release
      id: check_release
      run: |
        if helm status monitoring -n monitoring >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Install or upgrade monitoring stack
      run: |
        set -e
        if [ "${{ steps.check_release.outputs.exists }}" = "true" ]; then
          echo "Upgrading existing release..."
          helm upgrade monitoring prometheus-community/kube-prometheus-stack -n monitoring --install
        else
          echo "Installing new release..."
          helm install monitoring prometheus-community/kube-prometheus-stack -n monitoring
        fi

    - name: Ensure NGINX Ingress Controller
      run: |
          NAMESPACE="ingress-nginx"
          RELEASE="ingress-nginx"

          if helm status $RELEASE -n $NAMESPACE >/dev/null 2>&1; then
            echo "✅ NGINX Ingress Controller already installed in namespace '$NAMESPACE'."
          else
            echo "⚙️ Installing NGINX Ingress Controller..."
            kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
            helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
            helm repo update
            helm install $RELEASE ingress-nginx/ingress-nginx -n $NAMESPACE
          fi

    - name: Rollback on failure
      if: failure()
      run: |
        echo "Rolling back Helm release..."
        helm rollback monitoring 1 -n monitoring || echo "No rollback available"